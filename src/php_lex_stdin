#!/usr/bin/env php
<?php

error_reporting(E_ALL);

// e.g. thrift autogenerated files can be quite large
// and php needs a lot of memory even just to lex them
ini_set('memory_limit', '512M');

$source = stream_get_contents(STDIN);
$tokens = token_get_all($source);
unset($source);

$line_num = 1;
$col_num = 1;

/**
 * helper for encoding preg_replace for tokens containing newlines
 */
function nl_esc($s) {
  switch ($s) {
  case '@':
    return '@@';
  case "\n":
    return '@n';
  default:
    echo 'DEATH. unexpected substring to nl_esc';
    exit(-1);
  }
}

foreach ($tokens as $token) {
  if (is_array($token)) {
    list($name_const, $content) = $token;
    $name = substr(token_name($name_const), 2);
  } else {
    $name = 'LITERAL';
    $content = $token;
  }

  $esc_content = preg_replace("/(@|\\n)/e", "nl_esc('\\1')", $content);
  echo $name."\t".$line_num."\t".$col_num."\t".$esc_content."\n";

  $line_inc = substr_count($content, "\n");
  if ($line_inc) {
    $line_num += $line_inc;
    $col_num = strlen($content) - strrpos($content, "\n");
  } else {
    $col_num += strlen($content);
  }
}
